<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sub Gateway ç®¡ç†åå°</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        .login-card {
            background: var(--bg-card);
            padding: 3rem;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
        }

        .login-card h1 {
            text-align: center;
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-card p {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .btn {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            border: none;
            border-radius: 0.5rem;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px rgba(99, 102, 241, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .error-msg {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.25rem;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-logout {
            background: transparent;
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
        }

        .stat-card .label {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-card.active .value {
            color: var(--success);
        }

        .stat-card.disabled .value {
            color: var(--danger);
        }

        .stat-card.override .value {
            color: var(--warning);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-header h2 {
            font-size: 1.25rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px -5px rgba(99, 102, 241, 0.5);
        }

        .customer-table {
            width: 100%;
            background: var(--bg-card);
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .customer-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .customer-table th,
        .customer-table td {
            padding: 1rem;
            text-align: left;
        }

        .customer-table th {
            background: var(--bg-input);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .customer-table tr:not(:last-child) td {
            border-bottom: 1px solid var(--border);
        }

        .customer-table tr:hover td {
            background: rgba(99, 102, 241, 0.05);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.active {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .status-badge.disabled {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .status-badge.override {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
        }

        .btn-sm:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-sm.danger:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .link-copy {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-input);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            display: inline-block;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .link-copy:hover {
            color: var(--primary);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 1rem;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn-cancel {
            background: transparent;
            border: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .btn-cancel:hover {
            border-color: var(--text);
            color: var(--text);
        }

        textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text);
            font-size: 0.875rem;
            font-family: monospace;
            resize: vertical;
            min-height: 80px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .node-section {
            background: var(--bg-input);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .node-section h4 {
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }

            .customer-table {
                overflow-x: auto;
            }

            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-card">
            <h1>ğŸš€ Sub Gateway</h1>
            <p>ç®¡ç†åå°ç™»å½•</p>
            <div class="error-msg" id="loginError"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="username" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <button type="submit" class="btn">ç™» å½•</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <header class="header">
            <h1>ğŸš€ Sub Gateway ç®¡ç†åå°</h1>
            <div class="header-actions">
                <span id="adminUser"></span>
                <button class="btn-logout" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </header>

        <main class="main-content">
            <div class="stats">
                <div class="stat-card">
                    <div class="label">æ€»å®¢æˆ·æ•°</div>
                    <div class="value" id="totalCount">0</div>
                </div>
                <div class="stat-card active">
                    <div class="label">å·²å¯ç”¨</div>
                    <div class="value" id="activeCount">0</div>
                </div>
                <div class="stat-card disabled">
                    <div class="label">å·²ç¦ç”¨</div>
                    <div class="value" id="disabledCount">0</div>
                </div>
                <div class="stat-card override">
                    <div class="label">è¦†ç›–ä¸­</div>
                    <div class="value" id="overrideCount">0</div>
                </div>
            </div>

            <div class="section-header">
                <h2>å®¢æˆ·åˆ—è¡¨</h2>
                <button class="btn-primary" onclick="openCreateModal()">+ æ–°å»ºå®¢æˆ·</button>
            </div>

            <div class="customer-table">
                <table>
                    <thead>
                        <tr>
                            <th>å®¢æˆ·åç§°</th>
                            <th>çŠ¶æ€</th>
                            <th>è®¢é˜…é“¾æ¥</th>
                            <th>æ›´æ–°æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="customerList"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Create/Edit Modal -->
    <div class="modal-overlay" id="customerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">æ–°å»ºå®¢æˆ·</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <input type="hidden" id="editToken">
                    <div class="form-group">
                        <label>å®¢æˆ·åç§° *</label>
                        <input type="text" id="customerName" placeholder="ä¾‹ï¼šå®¢æˆ·A-å¼ ä¸‰" required>
                    </div>

                    <div class="node-section">
                        <h4>ğŸš€ ä¸»ç”¨èŠ‚ç‚¹ï¼ˆåŠ é€Ÿï¼‰</h4>
                        <div class="form-group">
                            <label>åˆ†äº«é“¾æ¥ (v2rayN) *</label>
                            <input type="text" id="primaryShare" placeholder="ss://... æˆ– socks5://..." required>
                        </div>
                        <div class="form-group">
                            <label>Clash é…ç½® (JSON)</label>
                            <textarea id="primaryClash"
                                placeholder='{"type":"ss","server":"x.x.x.x","port":8388,"cipher":"aes-256-gcm","password":"xxx"}'></textarea>
                        </div>
                    </div>

                    <div class="node-section">
                        <h4>ğŸ”„ å¤‡ç”¨èŠ‚ç‚¹ï¼ˆç›´è¿ï¼‰</h4>
                        <div class="form-group">
                            <label>åˆ†äº«é“¾æ¥ (v2rayN) *</label>
                            <input type="text" id="backupShare" placeholder="socks5://..." required>
                        </div>
                        <div class="form-group">
                            <label>Clash é…ç½® (JSON)</label>
                            <textarea id="backupClash"
                                placeholder='{"type":"socks5","server":"x.x.x.x","port":1080}'></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="saveCustomer()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Override Modal -->
    <div class="modal-overlay" id="overrideModal">
        <div class="modal">
            <div class="modal-header">
                <h3>è®¾ç½®åº”æ€¥è¦†ç›–</h3>
                <button class="modal-close" onclick="closeOverrideModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="overrideToken">
                <p style="color: var(--text-muted); margin-bottom: 1rem;">è®¾ç½®åï¼Œè®¢é˜…è¾“å‡ºå°†ä½¿ç”¨è¦†ç›–èŠ‚ç‚¹æ›¿ä»£åŸèŠ‚ç‚¹</p>
                <div class="form-group">
                    <label>è¦†ç›–ä¸»èŠ‚ç‚¹åˆ†äº«é“¾æ¥</label>
                    <input type="text" id="overridePrimaryShare" placeholder="ss://... æˆ–ç•™ç©º">
                </div>
                <div class="form-group">
                    <label>è¦†ç›–å¤‡ç”¨èŠ‚ç‚¹åˆ†äº«é“¾æ¥</label>
                    <input type="text" id="overrideBackupShare" placeholder="socks5://... æˆ–ç•™ç©º">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <input type="text" id="overrideNote" placeholder="ä¾‹ï¼šä¸­è½¬æ•…éšœï¼Œä¸´æ—¶åˆ‡æ¢">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeOverrideModal()">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="saveOverride()">è®¾ç½®è¦†ç›–</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Custom Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="confirmTitle">ç¡®è®¤</h3>
                <button class="modal-close" onclick="closeConfirmModal(false)">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="color: var(--text); margin: 0;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeConfirmModal(false)">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="closeConfirmModal(true)">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal-overlay" id="qrcodeModal">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h3 id="qrcodeTitle">è®¢é˜…äºŒç»´ç </h3>
                <button class="modal-close" onclick="closeQRModal()">&times;</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <button class="btn-sm" id="qrV2rayBtn" onclick="showQR('v2rayn')"
                        style="padding: 0.5rem 1rem;">v2rayN</button>
                    <button class="btn-sm" id="qrClashBtn" onclick="showQR('clash')"
                        style="padding: 0.5rem 1rem;">Clash</button>
                </div>
                <canvas id="qrcodeCanvas" style="border-radius: 0.5rem;"></canvas>
                <p id="qrcodeUrl"
                    style="font-size: 0.75rem; color: var(--text-muted); word-break: break-all; margin-top: 0.5rem;">
                </p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn-primary" onclick="closeQRModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        let authHeader = '';
        let customers = [];
        let confirmResolve = null;

        // Custom confirm dialog
        function showConfirm(message, title = 'ç¡®è®¤') {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('active');
            return new Promise(resolve => {
                confirmResolve = resolve;
            });
        }

        function closeConfirmModal(result) {
            document.getElementById('confirmModal').classList.remove('active');
            if (confirmResolve) {
                confirmResolve(result);
                confirmResolve = null;
            }
        }

        // QR Code functions
        let currentQRUrls = {};
        let currentQRType = 'v2rayn';

        function openQRModal(urls, customerName) {
            currentQRUrls = urls;
            document.getElementById('qrcodeTitle').textContent = customerName + ' - è®¢é˜…äºŒç»´ç ';
            document.getElementById('qrcodeModal').classList.add('active');
            showQR('v2rayn');
        }

        function showQR(type) {
            currentQRType = type;
            const url = currentQRUrls[type];

            // Update button styles
            document.getElementById('qrV2rayBtn').style.borderColor = type === 'v2rayn' ? 'var(--primary)' : 'var(--border)';
            document.getElementById('qrV2rayBtn').style.color = type === 'v2rayn' ? 'var(--primary)' : 'var(--text-muted)';
            document.getElementById('qrClashBtn').style.borderColor = type === 'clash' ? 'var(--primary)' : 'var(--border)';
            document.getElementById('qrClashBtn').style.color = type === 'clash' ? 'var(--primary)' : 'var(--text-muted)';

            // Generate QR code
            const canvas = document.getElementById('qrcodeCanvas');
            QRCode.toCanvas(canvas, url, {
                width: 256,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#ffffff'
                }
            }, function (error) {
                if (error) console.error(error);
            });

            document.getElementById('qrcodeUrl').textContent = url;
        }

        function closeQRModal() {
            document.getElementById('qrcodeModal').classList.remove('active');
        }

        // Check saved auth on load
        window.onload = () => {
            const saved = sessionStorage.getItem('auth');
            if (saved) {
                authHeader = saved;
                showDashboard();
            }
        };

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            authHeader = 'Basic ' + btoa(username + ':' + password);

            try {
                const res = await fetch('/admin/customers', {
                    headers: { 'Authorization': authHeader }
                });

                if (res.ok) {
                    sessionStorage.setItem('auth', authHeader);
                    document.getElementById('adminUser').textContent = username;
                    showDashboard();
                } else {
                    document.getElementById('loginError').textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
                    document.getElementById('loginError').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('loginError').textContent = 'è¿æ¥å¤±è´¥';
                document.getElementById('loginError').style.display = 'block';
            }
        });

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadCustomers();
        }

        function logout() {
            sessionStorage.removeItem('auth');
            authHeader = '';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        async function loadCustomers() {
            try {
                const res = await fetch('/admin/customers', {
                    headers: { 'Authorization': authHeader }
                });
                customers = await res.json();
                renderCustomers();
                updateStats();
            } catch (err) {
                showToast('åŠ è½½å¤±è´¥', 'error');
            }
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = customers.length;
            document.getElementById('activeCount').textContent = customers.filter(c => c.enabled).length;
            document.getElementById('disabledCount').textContent = customers.filter(c => !c.enabled).length;
            document.getElementById('overrideCount').textContent = customers.filter(c => c.has_override).length;
        }

        function renderCustomers() {
            const tbody = document.getElementById('customerList');
            tbody.innerHTML = customers.map(c => `
                <tr>
                    <td><strong>${escapeHtml(c.name)}</strong></td>
                    <td>
                        <span class="status-badge ${c.enabled ? 'active' : 'disabled'}">
                            ${c.enabled ? 'âœ“ å¯ç”¨' : 'âœ— ç¦ç”¨'}
                        </span>
                        ${c.has_override ? '<span class="status-badge override">âš¡ è¦†ç›–ä¸­</span>' : ''}
                    </td>
                    <td>
                        <span class="link-copy" onclick="copyLink('${c.subscribe_urls.v2rayn}')" title="ç‚¹å‡»å¤åˆ¶ v2rayN">
                            v2rayN
                        </span>
                        <span class="link-copy" onclick="copyLink('${c.subscribe_urls.clash}')" title="ç‚¹å‡»å¤åˆ¶ Clash">
                            Clash
                        </span>
                        <span class="link-copy" onclick="openQRModal({v2rayn: '${c.subscribe_urls.v2rayn}', clash: '${c.subscribe_urls.clash}'}, '${escapeHtml(c.name)}')" title="æ˜¾ç¤ºäºŒç»´ç " style="background: var(--primary); color: white;">
                            ğŸ“± äºŒç»´ç 
                        </span>
                    </td>
                    <td style="color: var(--text-muted); font-size: 0.875rem;">
                        ${new Date(c.updated_at).toLocaleString('zh-CN')}
                    </td>
                    <td>
                        <div class="actions">
                            <button class="btn-sm" onclick="toggleEnabled('${c.token}', ${!c.enabled})">
                                ${c.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn-sm" onclick="openOverrideModal('${c.token}')">
                                ${c.has_override ? 'ä¿®æ”¹è¦†ç›–' : 'è®¾ç½®è¦†ç›–'}
                            </button>
                            ${c.has_override ? `<button class="btn-sm" onclick="clearOverride('${c.token}', event)">æ¸…é™¤è¦†ç›–</button>` : ''}
                            <button class="btn-sm" onclick="rotateToken('${c.token}')">è½®æ¢Token</button>
                            <button class="btn-sm danger" onclick="deleteCustomer('${c.token}', '${escapeHtml(c.name)}')">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyLink(url) {
            navigator.clipboard.writeText(url);
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        function openCreateModal() {
            document.getElementById('modalTitle').textContent = 'æ–°å»ºå®¢æˆ·';
            document.getElementById('editToken').value = '';
            document.getElementById('customerForm').reset();
            document.getElementById('customerModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('customerModal').classList.remove('active');
        }

        async function saveCustomer() {
            const name = document.getElementById('customerName').value;
            const primaryShare = document.getElementById('primaryShare').value;
            const backupShare = document.getElementById('backupShare').value;

            let primaryClash = null;
            let backupClash = null;

            try {
                const pc = document.getElementById('primaryClash').value.trim();
                if (pc) primaryClash = JSON.parse(pc);
            } catch (e) {
                showToast('ä¸»èŠ‚ç‚¹ Clash é…ç½® JSON æ ¼å¼é”™è¯¯', 'error');
                return;
            }

            try {
                const bc = document.getElementById('backupClash').value.trim();
                if (bc) backupClash = JSON.parse(bc);
            } catch (e) {
                showToast('å¤‡ç”¨èŠ‚ç‚¹ Clash é…ç½® JSON æ ¼å¼é”™è¯¯', 'error');
                return;
            }

            const body = {
                name,
                nodes: {
                    primary: { share: primaryShare, clash: primaryClash },
                    backup: { share: backupShare, clash: backupClash }
                }
            };

            try {
                const res = await fetch('/admin/customers', {
                    method: 'POST',
                    headers: {
                        'Authorization': authHeader,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    const data = await res.json();
                    showToast('å®¢æˆ·åˆ›å»ºæˆåŠŸ');
                    closeModal();
                    loadCustomers();

                    // Show subscription URLs
                    setTimeout(() => {
                        alert(`å®¢æˆ·åˆ›å»ºæˆåŠŸï¼\n\nToken: ${data.token}\n\nv2rayN è®¢é˜…:\n${data.subscribe_urls.v2rayn}\n\nClash è®¢é˜…:\n${data.subscribe_urls.clash}`);
                    }, 100);
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'åˆ›å»ºå¤±è´¥', 'error');
                }
            } catch (err) {
                showToast('è¯·æ±‚å¤±è´¥', 'error');
            }
        }

        async function toggleEnabled(token, enabled) {
            try {
                const res = await fetch(`/admin/customers/${token}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': authHeader,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });

                if (res.ok) {
                    showToast(enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨');
                    loadCustomers();
                } else {
                    showToast('æ“ä½œå¤±è´¥', 'error');
                }
            } catch (err) {
                showToast('è¯·æ±‚å¤±è´¥', 'error');
            }
        }

        async function rotateToken(token) {
            const confirmed = await showConfirm('ç¡®å®šè¦è½®æ¢ Token å—ï¼Ÿæ—§ Token å°†ç«‹å³å¤±æ•ˆï¼Œéœ€è¦å‘å®¢æˆ·å‘é€æ–°çš„è®¢é˜…é“¾æ¥ã€‚', 'è½®æ¢ Token');
            if (!confirmed) return;

            try {
                const res = await fetch(`/admin/customers/${token}/rotate`, {
                    method: 'POST',
                    headers: { 'Authorization': authHeader }
                });

                if (res.ok) {
                    const data = await res.json();
                    showToast('Token å·²è½®æ¢');
                    loadCustomers();

                    setTimeout(() => {
                        alert(`Token è½®æ¢æˆåŠŸï¼\n\næ–° v2rayN è®¢é˜…:\n${data.subscribe_urls.v2rayn}\n\næ–° Clash è®¢é˜…:\n${data.subscribe_urls.clash}`);
                    }, 100);
                } else {
                    showToast('è½®æ¢å¤±è´¥', 'error');
                }
            } catch (err) {
                showToast('è¯·æ±‚å¤±è´¥', 'error');
            }
        }

        function openOverrideModal(token) {
            document.getElementById('overrideToken').value = token;
            document.getElementById('overridePrimaryShare').value = '';
            document.getElementById('overrideBackupShare').value = '';
            document.getElementById('overrideNote').value = '';
            document.getElementById('overrideModal').classList.add('active');
        }

        function closeOverrideModal() {
            document.getElementById('overrideModal').classList.remove('active');
        }

        async function saveOverride() {
            const token = document.getElementById('overrideToken').value;
            const primaryShare = document.getElementById('overridePrimaryShare').value.trim();
            const backupShare = document.getElementById('overrideBackupShare').value.trim();
            const note = document.getElementById('overrideNote').value.trim();

            if (!primaryShare && !backupShare) {
                showToast('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªè¦†ç›–èŠ‚ç‚¹', 'error');
                return;
            }

            const body = { note };
            if (primaryShare) body.primary = { share: primaryShare };
            if (backupShare) body.backup = { share: backupShare };

            try {
                const res = await fetch(`/admin/customers/${token}/override`, {
                    method: 'POST',
                    headers: {
                        'Authorization': authHeader,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    showToast('è¦†ç›–å·²è®¾ç½®');
                    closeOverrideModal();
                    loadCustomers();
                } else {
                    showToast('è®¾ç½®å¤±è´¥', 'error');
                }
            } catch (err) {
                showToast('è¯·æ±‚å¤±è´¥', 'error');
            }
        }

        async function clearOverride(token, event) {
            if (event) event.stopPropagation();

            const confirmed = await showConfirm('ç¡®å®šè¦æ¸…é™¤è¦†ç›–å—ï¼Ÿè®¢é˜…å°†æ¢å¤åˆ°åŸèŠ‚ç‚¹ã€‚', 'æ¸…é™¤è¦†ç›–');
            if (!confirmed) return;

            try {
                const res = await fetch(`/admin/customers/${token}/override`, {
                    method: 'DELETE',
                    headers: { 'Authorization': authHeader }
                });

                if (res.ok) {
                    showToast('è¦†ç›–å·²æ¸…é™¤');
                    await loadCustomers();
                } else {
                    showToast('æ¸…é™¤å¤±è´¥', 'error');
                }
            } catch (err) {
                showToast('è¯·æ±‚å¤±è´¥', 'error');
            }
        }

        async function deleteCustomer(token, name) {
            const confirmed = await showConfirm(`ç¡®å®šè¦åˆ é™¤å®¢æˆ· "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`, 'åˆ é™¤å®¢æˆ·');
            if (!confirmed) return;

            try {
                const res = await fetch(`/admin/customers/${token}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': authHeader }
                });

                if (res.ok) {
                    showToast('å®¢æˆ·å·²åˆ é™¤');
                    loadCustomers();
                } else {
                    showToast('åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (err) {
                showToast('è¯·æ±‚å¤±è´¥', 'error');
            }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>

</html>